// Generated by CoffeeScript 1.6.3
var methods, request, util;

request = require('superagent');

util = require('./util');

methods = {
  'create': 'post',
  'update': 'put',
  'patch': 'patch',
  'destroy': 'del',
  'read': 'get'
};

module.exports = function(method, mod, opt, cb) {
  var req, url, urls, verb;
  if (opt == null) {
    opt = {};
  }
  if (typeof opt === 'function' && !cb) {
    cb = opt;
    opt = {};
  }
  if (methods[method] == null) {
    throw new Error("Invalid method");
  }
  verb = methods[method];
  if (mod.urls != null) {
    urls = util.result(mod.urls, mod);
    url = util.result(urls[method], mod);
  } else if (mod.url != null) {
    url = util.result(mod.url, mod);
  }
  if (typeof url !== 'string') {
    throw new Error("Missing url");
  }
  if (opt.type == null) {
    opt.type = 'json';
  }
  req = request[verb](url).set('Accept', 'application/json');
  if (opt.headers) {
    req.set(util.result(opt.headers));
  }
  if (opt.query) {
    req.query(util.result(opt.query));
  }
  if (opt.username && opt.password) {
    req.auth(util.result(opt.username), util.result(opt.password));
  }
  if (util.result(opt.withCredentials) === true) {
    req.withCredentials();
  }
  if (verb !== "get") {
    req.type(util.result(opt.type));
    req.send(util.result(opt.attrs) || mod.toJSON());
  }
  return req.end(cb);
};
